
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.10">
    
    
      
        <title>day14 drf-中篇 - Kento's Wiki</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.7e359304.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#day14-drf-" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Kento&#39;s Wiki" class="md-header__button md-logo" aria-label="Kento's Wiki" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Kento's Wiki
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              day14 drf-中篇
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Kento&#39;s Wiki" class="md-nav__button md-logo" aria-label="Kento's Wiki" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Kento's Wiki
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Dev_documents
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Dev_documents
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Dev_documents/about_git/git/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.关于Git
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Dev_documents/request_process/%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2.网络请求流程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Dev_documents/oppProgramming/opp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    9.面向对象程序设计
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Django
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Django
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hello/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Hello
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../message/message/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.message组件
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../requestObj/restframeworkRequestObj/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2.restframework Request对象
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../restframework_authentication/restframework_authentication/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3.restframework认证组件
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../restframework_permission/restframework_permission/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4.restframework权限组件
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../restframeworkThrottle/restframeworkThrottle/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    5.restframework 限流
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../restframework_practice/restframework_blog/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    6.restframework：blog
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reatframework_serializer/reatframework_serializer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    7.restframework序列化
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reatframework_serializer_isvalid/reatframework_serializer_isvalid/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    8.restframework数据校验
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reatframework_version/reatframework_version/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    9.restframework版本控制
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../restframework_pager/restframework_pager/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    10.restframework Pager
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../django_Jsonresponse/django_Jsonresponse/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    11.JsonResponse对象
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../django_QueryDict/django_QueryDict/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    12.DjangoQueryDict对象
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../django_request/django_request/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    13.djangoRequest对象
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../metaClass/metaClass/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    14.metaclass元类
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    C(2022)
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            C(2022)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../C%282022%29/before/before/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.数据类型和输入输出
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../C%282022%29/scanf/scanf/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2.scanf
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../C%282022%29/expression/expression/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3.运算符与逻辑运算
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../C%282022%29/pointer/pointer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4.指针
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../C%282022%29/struct/struct/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    5.结构体
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    DataStruct
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            DataStruct
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../DataStruct/complexity/complexity/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.时间&空间复杂度
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../DataStruct/LinearList/LinearList/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2.线性表
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../DataStruct/stack/stack/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3.栈
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../DataStruct/queue/queue/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4.队列
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../DataStruct/tree/tree/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    5.树
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../DataStruct/map/map/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    6.图
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../DataStruct/search/search/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    7.查找
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../DataStruct/sort/sort/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    8.排序
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    <span class="md-ellipsis">
      1.版本
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.版本">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-get" class="md-nav__link">
    <span class="md-ellipsis">
      1.1 GET参数传递
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-url" class="md-nav__link">
    <span class="md-ellipsis">
      1.2 URL路径传递（*）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13" class="md-nav__link">
    <span class="md-ellipsis">
      1.3 请求头传递
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#14-url" class="md-nav__link">
    <span class="md-ellipsis">
      1.4 反向生成URL
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    <span class="md-ellipsis">
      2.解析器
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.解析器">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-jsonparser" class="md-nav__link">
    <span class="md-ellipsis">
      2.1 JSONParser （*）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-formparser" class="md-nav__link">
    <span class="md-ellipsis">
      2.2 FormParser
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-multipartparser" class="md-nav__link">
    <span class="md-ellipsis">
      2.3 MultiPartParser（*）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24-fileuploadparser" class="md-nav__link">
    <span class="md-ellipsis">
      2.4 FileUploadParser（*）
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    <span class="md-ellipsis">
      3.序列化器
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.序列化器">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31" class="md-nav__link">
    <span class="md-ellipsis">
      3.1 序列化数据
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.1 序列化数据">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#311-serializer" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.1 Serializer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#312-modelserializer" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.2 ModelSerializer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#313" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.3 字段和参数
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#314" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.4 序列化类嵌套
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#315" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.5 序列化类继承
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#316" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.6 底层实现原理（扩展）
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.1.6 底层实现原理（扩展）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1_1" class="md-nav__link">
    <span class="md-ellipsis">
      1.元类
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_1" class="md-nav__link">
    <span class="md-ellipsis">
      2.实例化字段对象
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3_1" class="md-nav__link">
    <span class="md-ellipsis">
      3.序列化类的创建
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4_declared_fields" class="md-nav__link">
    <span class="md-ellipsis">
      4._declared_fields
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    <span class="md-ellipsis">
      5.创建序列化类对象
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-" class="md-nav__link">
    <span class="md-ellipsis">
      6.序列化-当前类
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-listserializer" class="md-nav__link">
    <span class="md-ellipsis">
      7.序列化-ListSerializer
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32" class="md-nav__link">
    <span class="md-ellipsis">
      3.2 数据校验
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.2 数据校验">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#321" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.1 内置校验
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#322" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.2 正则校验
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#323" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.3 钩子校验
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#324-model" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.4 Model校验
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#325" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.5 校验+保存
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#326-fkm2m" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.6 校验+保存+FK+M2M
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#327-create" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.7 钩子create
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33" class="md-nav__link">
    <span class="md-ellipsis">
      3.3 校验+序列化
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.3 校验+序列化">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#331" class="md-nav__link">
    <span class="md-ellipsis">
      3.3.1 二合一
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#332" class="md-nav__link">
    <span class="md-ellipsis">
      3.3.2 独立分开
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    <span class="md-ellipsis">
      4.分页
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.分页">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-pagenumberpagination" class="md-nav__link">
    <span class="md-ellipsis">
      4.1 PageNumberPagination
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-limitoffsetpagination" class="md-nav__link">
    <span class="md-ellipsis">
      4.2 LimitOffsetPagination
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5_1" class="md-nav__link">
    <span class="md-ellipsis">
      5.初识视图
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="day14-drf-">day14 drf-中篇</h1>
<p>上节内容：前后端分离概述、纯净项目、request对象、认证、权限、限流等。</p>
<p>本节内容：</p>
<ul>
<li><strong>版本</strong>，在请求中携带版本号，便于后续API的更新迭代。</li>
</ul>
<pre><code>http://www.5xclass/api/v1/info
http://www.5xclass/api/v2/info
</code></pre>
<ul>
<li><strong>解析器</strong>，读取不同格式数据进行解析然后赋值给request.data等对象中。</li>
</ul>
<pre><code>user=wupeiqi&amp;age=123
{&quot;user&quot;:&quot;wupeiqi&quot;,&quot;age&quot;:123}
</code></pre>
<ul>
<li>
<p><strong>序列化器</strong>，将ORM获取的数据库QuerySet或数据对象<strong>序列化</strong>成JSON格式 + <strong>请求数据格式校验</strong>。（最重要）</p>
</li>
<li>
<p><strong>分页</strong>，对ORM中获取的数据进行分页处理，分批返回给用户。</p>
</li>
<li>
<p><strong>视图</strong>，drf中提供了APIView+其他视图类让我们来继承。</p>
</li>
</ul>
<h2 id="1">1.版本</h2>
<p>在restful规范中要去，后端的API中需要体现版本。</p>
<h3 id="11-get">1.1 GET参数传递</h3>
<p><img alt="image-20210819154455680" src="../assets/image-20210819154455680.png" /></p>
<pre><code class="language-python"># settings.py

REST_FRAMEWORK = {
    &quot;VERSION_PARAM&quot;: &quot;v&quot;,
    &quot;DEFAULT_VERSION&quot;: &quot;v1&quot;,
    &quot;ALLOWED_VERSIONS&quot;: [&quot;v1&quot;, &quot;v2&quot;, &quot;v3&quot;],
    &quot;DEFAULT_VERSIONING_CLASS&quot;:&quot;rest_framework.versioning.QueryParameterVersioning&quot;
}
</code></pre>
<p>源码执行流程：</p>
<p><img alt="image-20210820105543193" src="../assets/image-20210820105543193.png" /></p>
<h3 id="12-url">1.2 URL路径传递（*）</h3>
<p><img alt="image-20210819154955480" src="../assets/image-20210819154955480.png" /></p>
<h3 id="13">1.3 请求头传递</h3>
<p><img alt="image-20210819155617845" src="../assets/image-20210819155617845.png" /></p>
<h3 id="14-url">1.4 反向生成URL</h3>
<p>在每个版本处理的类中还定义了<code>reverse</code>方法，他是用来反向生成URL并携带相关的的版本信息用的，例如：</p>
<p><img alt="image-20210820105543193" src="../assets/image-20210820105543193-3386187.png" /></p>
<p><img alt="image-20210820112152615" src="../assets/image-20210820112152615.png" /></p>
<h2 id="2">2.解析器</h2>
<p>使用 <code>request.data</code> 获取<strong>请求体</strong>中的数据。</p>
<p>这个 <code>reqeust.data</code> 的数据怎么来的呢？其实在drf内部是由解析器，根据请求者传入的数据格式 + 请求头来进行处理。</p>
<h3 id="21-jsonparser">2.1 JSONParser （*）</h3>
<p><img alt="image-20210827081058194" src="../assets/image-20210827081058194.png" /></p>
<h3 id="22-formparser">2.2 FormParser</h3>
<p><img alt="image-20210827081244795" src="../assets/image-20210827081244795.png" /></p>
<h3 id="23-multipartparser">2.3 MultiPartParser（*）</h3>
<p><img alt="image-20210827083047327" src="../assets/image-20210827083047327.png" /></p>
<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;title&gt;Title&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;form action=&quot;http://127.0.0.1:8000/test/&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;
    &lt;input type=&quot;text&quot; name=&quot;user&quot; /&gt;
    &lt;input type=&quot;file&quot; name=&quot;img&quot;&gt;

    &lt;input type=&quot;submit&quot; value=&quot;提交&quot;&gt;

&lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<h3 id="24-fileuploadparser">2.4 FileUploadParser（*）</h3>
<p><img alt="image-20210827084403453" src="../assets/image-20210827084403453.png" /></p>
<p>解析器可以设置多个，默认解析器：</p>
<pre><code class="language-python">from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework.parsers import MultiPartParser, JSONParser, FormParser

class UserView(APIView):

    def post(self, request):
        print(request.content_type)
        print(request.data)

        return Response(&quot;...&quot;)

</code></pre>
<h2 id="3">3.序列化器</h2>
<h3 id="31">3.1 序列化数据</h3>
<h4 id="311-serializer">3.1.1 Serializer</h4>
<pre><code class="language-python">from django.db import models


class Role(models.Model):
    title = models.CharField(verbose_name=&quot;标题&quot;, max_length=32)
    order = models.IntegerField(verbose_name=&quot;顺序&quot;)
</code></pre>
<pre><code class="language-python">from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import serializers
from api import models


class InfoSerializer(serializers.Serializer):
    id = serializers.IntegerField()
    title = serializers.CharField()
    order = serializers.IntegerField()


class InfoView(APIView):
    def get(self, request):
        # 1.数据库获取多条数据
        # queryset = models.Role.objects.all()
        # ser = InfoSerializer(instance=queryset, many=True)

        # 2.数据库获取单条数据
        instance = models.Role.objects.all().first()
        ser = InfoSerializer(instance=instance, many=False)

        print(type(ser.data), ser.data)
        return Response(ser.data)

</code></pre>
<h4 id="312-modelserializer">3.1.2 ModelSerializer</h4>
<pre><code class="language-python">from django.db import models


class Role(models.Model):
    title = models.CharField(verbose_name=&quot;标题&quot;, max_length=32)
    order = models.IntegerField(verbose_name=&quot;顺序&quot;)
</code></pre>
<pre><code class="language-python">from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import serializers
from api import models


class InfoSerializer(serializers.ModelSerializer):
    class Meta:
        model = models.Role
        # fields = &quot;__all__&quot;
        # fields = ['id', 'title', 'order']
        exclude = [&quot;id&quot;]


class InfoView(APIView):
    def get(self, request):
        # 1.数据库获取多条数据
        # queryset = models.Role.objects.all()
        # ser = InfoSerializer(instance=queryset, many=True)

        # 2.数据库获取单条数据
        instance = models.Role.objects.all().first()
        ser = InfoSerializer(instance=instance, many=False)

        print(type(ser.data), ser.data)
        return Response(ser.data)
</code></pre>
<p>很显然，如果要对数据表中的字段进行序列化，使用ModelModelSerializer是要比Serializer更简洁一些的。</p>
<h4 id="313">3.1.3 字段和参数</h4>
<p>在<code>ModelModelSerializer</code>和<code>Serializer</code>中都可以自定义字段，并传入一些相关参数。</p>
<pre><code class="language-python">from django.db import models


class Role(models.Model):
    title = models.CharField(verbose_name=&quot;标题&quot;, max_length=32)
    order = models.IntegerField(verbose_name=&quot;顺序&quot;)


class UserInfo(models.Model):
    name = models.CharField(verbose_name=&quot;姓名&quot;, max_length=32)
    gender = models.SmallIntegerField(verbose_name=&quot;性别&quot;, choices=((1, &quot;男&quot;), (2, &quot;女&quot;)))
    role = models.ForeignKey(verbose_name=&quot;角色&quot;, to=&quot;Role&quot;, on_delete=models.CASCADE)
    ctime = models.DateTimeField(verbose_name=&quot;创建时间&quot;, auto_now_add=True)
</code></pre>
<pre><code class="language-python">from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import serializers
from api import models


class InfoSerializer(serializers.ModelSerializer):
    gender = serializers.CharField(source=&quot;get_gender_display&quot;)
    role = serializers.CharField(source=&quot;role.title&quot;)
    ctime = serializers.DateTimeField(format=&quot;%Y-%m-%d&quot;)
    other_name = serializers.CharField(source=&quot;name&quot;)
    mine = serializers.SerializerMethodField()

    class Meta:
        model = models.UserInfo
        fields = ['id', 'name', 'gender', &quot;role&quot;, 'ctime', &quot;other_name&quot;, &quot;mine&quot;]

    def get_mine(self, obj):
        return &quot;x-x-{}&quot;.format(obj.name)


class InfoView(APIView):
    def get(self, request):
        queryset = models.UserInfo.objects.all()
        ser = InfoSerializer(instance=queryset, many=True)
        print(type(ser.data), ser.data)
        return Response(ser.data)

</code></pre>
<p><img alt="image-20220917161121853" src="../assets/image-20220917161121853.png" /></p>
<h4 id="314">3.1.4 序列化类嵌套</h4>
<p>主要是ORM类中对应<code>ForeignKey</code> 和 <code>ManyToManyField</code>的字段进行序列化。</p>
<ul>
<li>基于<code>SerializerMethodField</code>自定义方法对关联表数据进行序列化</li>
<li>基于嵌套的序列化类实现</li>
</ul>
<p><img alt="image-20220917161811985" src="../assets/image-20220917161811985.png" /></p>
<pre><code class="language-python">from django.db import models


class Role(models.Model):
    title = models.CharField(verbose_name=&quot;标题&quot;, max_length=32)
    order = models.IntegerField(verbose_name=&quot;顺序&quot;)


class Tag(models.Model):
    caption = models.CharField(verbose_name=&quot;名称&quot;, max_length=32)


class UserInfo(models.Model):
    name = models.CharField(verbose_name=&quot;姓名&quot;, max_length=32)
    gender = models.SmallIntegerField(verbose_name=&quot;性别&quot;, choices=((1, &quot;男&quot;), (2, &quot;女&quot;)))
    role = models.ForeignKey(verbose_name=&quot;角色&quot;, to=&quot;Role&quot;, on_delete=models.CASCADE)
    ctime = models.DateTimeField(verbose_name=&quot;创建时间&quot;, auto_now_add=True)

    tags = models.ManyToManyField(verbose_name=&quot;标签&quot;, to=&quot;Tag&quot;)

</code></pre>
<pre><code class="language-python">from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import serializers
from api import models


class RoleSerializer(serializers.ModelSerializer):
    class Meta:
        model = models.Role
        # fields = &quot;__all__&quot;
        fields = [&quot;id&quot;, 'title']


class TagSerializer(serializers.ModelSerializer):
    class Meta:
        model = models.Tag
        fields = &quot;__all__&quot;


class InfoSerializer(serializers.ModelSerializer):
    role = RoleSerializer()
    tags = TagSerializer(many=True)

    class Meta:
        model = models.UserInfo
        fields = ['id', 'name', &quot;role&quot;, &quot;tags&quot;]


class InfoView(APIView):
    def get(self, request):
        queryset = models.UserInfo.objects.all()
        ser = InfoSerializer(instance=queryset, many=True)
        print(type(ser.data), ser.data)
        return Response(ser.data)
</code></pre>
<h4 id="315">3.1.5 序列化类继承</h4>
<pre><code class="language-python">from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import serializers
from api import models


class MySerializer(serializers.Serializer):
    more = serializers.SerializerMethodField()

    def get_more(self, obj):
        return &quot;123&quot;


class InfoSerializer(serializers.ModelSerializer, MySerializer):
    class Meta:
        model = models.UserInfo
        fields = [&quot;id&quot;, &quot;name&quot;, 'more']


class InfoView(APIView):
    def get(self, request):
        instance = models.UserInfo.objects.all().first()
        ser = InfoSerializer(instance=instance, many=False)

        print(type(ser.data), ser.data)
        return Response(ser.data)
</code></pre>
<h4 id="316">3.1.6 底层实现原理（扩展）</h4>
<p>声明：掌握上述知识点，已经可以让你完成工作中常见的任务。接下来的知识点，只是作为扩展，可以略过。</p>
<h5 id="1_1">1.元类</h5>
<p>对象是通过类实例化出来的。</p>
<pre><code class="language-python">class Foo(object):
    pass

# 第1步：调用Foo的__new__方法创建空对象。
# 第2步：调用Foo的__init__方法对对象进行初始化。
obj = Foo()
</code></pre>
<p>类是谁创建的？是由type创建出来的（默认）。</p>
<pre><code class="language-python">class Foo(object):
    v1 = 123

    def func(self):
        return 666
</code></pre>
<pre><code class="language-python">Foo = type(&quot;Foo&quot;,(object,),{ &quot;v1&quot;:123, &quot;func&quot;:lambda self:666 })
</code></pre>
<p>定义类时加入metaclass指定当前类的创造者。</p>
<pre><code class="language-python"># 由type创建Foo类型
class Foo(object):
    pass
</code></pre>
<pre><code class="language-python"># 由`东西` 创建Foo类型
class Foo(object,metaclass=东西):
    pass
</code></pre>
<p>指定元类(metaclass) 来创建类。</p>
<pre><code class="language-python">class MyType(type):
    def __new__(cls, *args, **kwargs):
        new_cls = super().__new__(cls, *args, **kwargs)
        print(&quot;创建类：&quot;, new_cls)
        return new_cls

class Foo(metaclass=MyType):
    pass
</code></pre>
<pre><code class="language-python">class MyType(type):
    def __init__(self, *args, **kwargs):
        print(&quot;第2步：初始化类成员：&quot;, args, **kwargs)
        super().__init__(*args, **kwargs)

    def __new__(cls, *args, **kwargs):
        new_cls = super().__new__(cls, *args, **kwargs)
        print(&quot;第1步：创建类：&quot;, new_cls)
        return new_cls


class Foo(metaclass=MyType):
    v1 = 123

    def func(self):
        pass
</code></pre>
<pre><code class="language-python">class MyType(type):
    def __init__(cls, *args, **kwargs):
        print(&quot;第2步：初始化类成员：&quot;, args, **kwargs)
        super().__init__(*args, **kwargs)

    def __new__(cls, *args, **kwargs):
        new_cls = super().__new__(cls, *args, **kwargs)
        print(&quot;第1步：创建类：&quot;, new_cls)
        return new_cls

    def __call__(cls, *args, **kwargs):
        print(&quot;第3步：创建对象&amp;初始化对象&quot;, cls)

        # 1.调用自己那个类的 __new__ 方法去创建对象
        new_object = cls.__new__(cls, *args, **kwargs)

        # 2.调用你自己那个类 __init__放发去初始化
        cls.__init__(new_object, *args, **kwargs)
        return new_object


class Foo(metaclass=MyType):
    v1 = 123

    def func(self):
        pass


obj = Foo()
</code></pre>
<h5 id="2_1">2.实例化字段对象</h5>
<pre><code class="language-python">from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import serializers
from api import models


class InfoSerializer(serializers.Serializer):
    id = serializers.IntegerField()
    title = serializers.CharField()
    order = serializers.IntegerField
</code></pre>
<p>对于上述代码，在类<code>InfoSerializer</code>创建之前，其内部<code>id、title、order</code>字段会先进行实例化对象。</p>
<p>而这些<code>IntegerField</code>、<code>CharField</code>等字段的继承关系如下：</p>
<pre><code class="language-python">class Field:
    _creation_counter = 0

class IntegerField(Field):
    pass

class CharField(Field):
    pass

class DateTimeField(Field):
    pass
</code></pre>
<p>在<code>IntegerField</code>、<code>CharField</code>等字段实例化时，内部会维护一个计数器，来表示实例化的先后顺序。</p>
<pre><code class="language-python">class Field:
    _creation_counter = 0
    def __init__(self, *, read_only=False...):
        self._creation_counter = Field._creation_counter
        Field._creation_counter += 1

class IntegerField(Field):
    def __init__(self, **kwargs):
        ...
        super().__init__(**kwargs)

class CharField(Field):
    def __init__(self, **kwargs):
        ...
        super().__init__(**kwargs)
</code></pre>
<pre><code class="language-python">from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import serializers
from api import models


class InfoSerializer(serializers.Serializer):
    id = serializers.IntegerField()  # 对象，内部_creation_counter=0
    title = serializers.CharField()  # 对象，内部_creation_counter=1
    order = serializers.IntegerField # 对象，内部_creation_counter=2
</code></pre>
<p>注意：后续会通过这个计数器排序，以此来实现字段的先后执行。</p>
<h5 id="3_1">3.序列化类的创建</h5>
<pre><code class="language-python">class SerializerMetaclass(type):
    def __new__(cls, name, bases, attrs):
        attrs['_declared_fields'] = cls._get_declared_fields(bases, attrs)
        return super().__new__(cls, name, bases, attrs)
</code></pre>
<pre><code class="language-python">class Serializer(BaseSerializer, metaclass=SerializerMetaclass):
    ...

class ModelSerializer(Serializer):
    ...

class RoleSerializer(serializers.ModelSerializer):
    gender = serializers.CharField(source=&quot;get_gender_display&quot;)
    class Meta:
        model = models.Role
        fields = [&quot;id&quot;, 'title',&quot;gender&quot;]
</code></pre>
<p>注意：父类中指定metaclass，子类也会由此metaclass来创建类。</p>
<h5 id="4_declared_fields">4._declared_fields</h5>
<p>在创建类之前，元类的<code>__new__</code>方法在类成员中添加了一个<code>_declared_fields</code>（类变量）。</p>
<pre><code class="language-python">class SerializerMetaclass(type):
    @classmethod
    def _get_declared_fields(cls, bases, attrs):
        # 1.循环获取类中定义所有的成员（类变量、方法），筛选出继承自Fields的类的字段对象。
        # 注意：同时会将字段在当前类成员中移除
        fields = [
            (field_name, attrs.pop(field_name)) 
            for field_name, obj in list(attrs.items())
            if isinstance(obj, Field)
        ]
        # 2.根据字段的_creation_counter排序
        fields.sort(key=lambda x: x[1]._creation_counter)

        # Ensures a base class field doesn't override cls attrs, and maintains
        # field precedence when inheriting multiple parents. e.g. if there is a
        # class C(A, B), and A and B both define 'field', use 'field' from A.
        known = set(attrs)

        def visit(name):
            known.add(name)
            return name

        # 3.读取父类中的_declared_fields字段（父类先于子类创建、序列化类支持继承）
        base_fields = [
            (visit(name), f)
            for base in bases if hasattr(base, '_declared_fields')
            for name, f in base._declared_fields.items() if name not in known
        ]

        # 4.将父类和子类中的字段打包返回，赋值给当前类的_declared_fields
        return OrderedDict(base_fields + fields)

    def __new__(cls, name, bases, attrs):
        attrs['_declared_fields'] = cls._get_declared_fields(bases, attrs)
        return super().__new__(cls, name, bases, attrs)
</code></pre>
<pre><code class="language-python">class Serializer(BaseSerializer, metaclass=SerializerMetaclass):
    ...

class ModelSerializer(Serializer):
    ...

class RoleSerializer(serializers.ModelSerializer):
    gender = serializers.CharField(source=&quot;get_gender_display&quot;)
    class Meta:
        model = models.Role
        fields = [&quot;id&quot;, 'title',&quot;gender&quot;]
</code></pre>
<p>所以，当类序列化类加载完毕后，类中成员：</p>
<ul>
<li>剔除，字段对象。</li>
</ul>
<pre><code>RoleSerializer.gender   不存在
</code></pre>
<ul>
<li>新增，_declared_fields，是<code>OrderedDict</code>类型且内部包含所有字段。</li>
</ul>
<pre><code>RoleSerializer._declared_fields = {
    &quot;gender&quot;: CharField对象
}
</code></pre>
<ul>
<li>其他，保留原样。<code>RoleSerializer.Meta</code></li>
</ul>
<h5 id="5">5.创建序列化类对象</h5>
<p>在视图的方法，使用序列化类对 orm 获取的QuerySet或对象进行序列化时，需要先进行初始化类的对象。</p>
<pre><code class="language-python">class SerializerMetaclass(type):
    def __new__(cls, name, bases, attrs):
        attrs['_declared_fields'] = cls._get_declared_fields(bases, attrs)
        return super().__new__(cls, name, bases, attrs)
</code></pre>
<pre><code class="language-python">class BaseSerializer(Field):
    def __init__(self, instance=None, data=empty, **kwargs):
        self.instance = instance
        if data is not empty:
            self.initial_data = data
        self.partial = kwargs.pop('partial', False)
        self._context = kwargs.pop('context', {})
        kwargs.pop('many', None)
        super().__init__(**kwargs)

    def __new__(cls, *args, **kwargs):
        if kwargs.pop('many', False):
            # 调用 many_init 方法获取其他对象，返回
            return cls.many_init(*args, **kwargs)

        # 创建当前类的空对象，返回
        return super().__new__(cls, *args, **kwargs)


    @classmethod
    def many_init(cls, *args, **kwargs):
        ...
        child_serializer = cls(*args, **kwargs)
        list_kwargs = {
            'child': child_serializer,
        }
        meta = getattr(cls, 'Meta', None)
        list_serializer_class = getattr(meta, 'list_serializer_class', ListSerializer)
        return list_serializer_class(*args, **list_kwargs)

class Serializer(BaseSerializer, metaclass=SerializerMetaclass):
    ...

class ModelSerializer(Serializer):
    ...

class RoleSerializer(serializers.ModelSerializer):
    gender = serializers.CharField(source=&quot;get_gender_display&quot;)
    class Meta:
        model = models.Role
        fields = [&quot;id&quot;, 'title',&quot;gender&quot;]
</code></pre>
<pre><code class="language-python">instance = models.UserInfo.objects.all().first()

# 实例化对象，内部会：先执行__new__、再执行__init__
# 第1步：__new__
#   默认：many=True，返回ListSerializer对象； many=False，返回当前类InfoSerializer的对象。
# 第2步：__init__
#   此处就要根据__new__返回的不同对象，执行不同对象的__init__方法。
# =====&gt; 思考题：你觉得他为什么要这么设计？ &lt;======
ser = InfoSerializer(instance=instance, many=False)

# 获取序列化后的值
ser.data
</code></pre>
<h5 id="6-">6.序列化-当前类</h5>
<pre><code class="language-python">class Field:
    def get_attribute(self, instance):
        # source_attrs=[]  或 source_attrs=[&quot;xx&quot;,&quot;xx&quot;,&quot;xxx&quot;]
        return get_attribute(instance, self.source_attrs)

class CharField(Field):
    def to_representation(self, value):
        return str(value)
</code></pre>
<pre><code class="language-python">class BaseSerializer(Field):
    @property
    def data(self):
        # 第2步
        if not hasattr(self, '_data'):
            if self.instance is not None and not getattr(self, '_errors', None):
                # 第3步：用于序列化给对象进行初始化用的。
                self._data = self.to_representation(self.instance)
            elif hasattr(self, '_validated_data') and not getattr(self, '_errors', None):
                # 这里是用于对请求校验时，才触发执行的。
                self._data = self.to_representation(self.validated_data)
            else:
                # 这个是用于给Serializer，不传对象而传入initial_data参数用的。
                self._data = self.get_initial()
        return self._data

class Serializer(BaseSerializer, metaclass=SerializerMetaclass):
    @property
    def data(self):
        # 第1步
        ret = super().data
        return ReturnDict(ret, serializer=self)

    def to_representation(self, instance):
        # 第4步
        ret = OrderedDict()

        # 第5步：获取 _declared_fields 中所有非write_only字段，即：用于序列化的字段。
        #       如果是ModelSerializer，也会去寻找其Meta中定义的字段 + 字段的bind方法
        fields = self._readable_fields

        for field in fields:
            try:
                # 第5步：调用字段对象中的 get_attribute 方法
                attribute = field.get_attribute(instance)
            except SkipField:
                continue

            check_for_none = attribute.pk if isinstance(attribute, PKOnlyObject) else attribute
            if check_for_none is None:
                ret[field.field_name] = None
            else:
                # 第6步：调用字段对象中的 to_representation 方法
                ret[field.field_name] = field.to_representation(attribute)

        return ret

class ModelSerializer(Serializer):
    ...

class RoleSerializer(serializers.ModelSerializer):
    gender = serializers.CharField(source=&quot;get_gender_display&quot;)
    class Meta:
        model = models.Role
        fields = [&quot;id&quot;, 'title',&quot;gender&quot;]
</code></pre>
<pre><code class="language-python">instance = models.UserInfo.objects.all().first()
ser = InfoSerializer(instance=instance, many=False)

# 创建InfoSerializer类的对象，获取序列化后的值
ser.data
</code></pre>
<h5 id="7-listserializer">7.序列化-ListSerializer</h5>
<pre><code class="language-python">class BaseSerializer(Field):
    @property
    def data(self):
        if not hasattr(self, '_data'):
            if self.instance is not None and not getattr(self, '_errors', None):
                # 这里
                self._data = self.to_representation(self.instance)
            elif hasattr(self, '_validated_data') and not getattr(self, '_errors', None):
                self._data = self.to_representation(self.validated_data)
            else:
                self._data = self.get_initial()
        return self._data

class ListSerializer(BaseSerializer):
    @property
    def data(self):
        ret = super().data
        return ReturnList(ret, serializer=self)

    def to_representation(self, data):
        iterable = data.all() if isinstance(data, models.Manager) else data

        return [
            # 循环，利用序列化类去处理每个对象
            self.child.to_representation(item) for item in iterable
        ]

</code></pre>
<h3 id="32">3.2 数据校验</h3>
<p>对用户发来的请求数据进行校验。</p>
<h4 id="321">3.2.1 内置校验</h4>
<pre><code class="language-python">from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import serializers


class InfoSerializer(serializers.Serializer):
    title = serializers.CharField(required=True, max_length=20, min_length=6)
    order = serializers.IntegerField(required=False, max_value=100, min_value=10)
    level = serializers.ChoiceField(choices=[(&quot;1&quot;, &quot;高级&quot;), (2, &quot;中级&quot;)])


class InfoView(APIView):
    def post(self, request):
        ser = InfoSerializer(data=request.data)
        if ser.is_valid():
            return Response(ser.validated_data)
        else:
            return Response(ser.errors)
</code></pre>
<h4 id="322">3.2.2 正则校验</h4>
<pre><code class="language-python">from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import serializers
from django.core.validators import RegexValidator, EmailValidator


class InfoSerializer(serializers.Serializer):
    title = serializers.CharField(required=True, max_length=20, min_length=6)
    order = serializers.IntegerField(required=False, max_value=100, min_value=10)
    level = serializers.ChoiceField(choices=[(&quot;1&quot;, &quot;高级&quot;), (2, &quot;中级&quot;)])

    # email = serializers.EmailField()
    email = serializers.CharField(validators=[EmailValidator(message=&quot;邮箱格式错误&quot;)])

    more = serializers.CharField(validators=[RegexValidator(r&quot;\d+&quot;, message=&quot;格式错误&quot;)])

    code = serializers.CharField()


class InfoView(APIView):
    def post(self, request):
        ser = InfoSerializer(data=request.data)
        if ser.is_valid():
            return Response(ser.validated_data)
        else:
            return Response(ser.errors)
</code></pre>
<h4 id="323">3.2.3 钩子校验</h4>
<pre><code class="language-python">from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import serializers
from rest_framework import exceptions


class InfoSerializer(serializers.Serializer):
    title = serializers.CharField(required=True, max_length=20, min_length=6)
    order = serializers.IntegerField(required=False, max_value=100, min_value=10)
    code = serializers.CharField()

    def validate_code(self, value):
        print(value)
        if len(value) &gt; 6:
            raise exceptions.ValidationError(&quot;字段钩子校验失败&quot;)
        return value

    def validate(self, attrs):
        print(&quot;validate=&quot;, attrs)
        # api_settings.NON_FIELD_ERRORS_KEY
        # raise exceptions.ValidationError(&quot;全局钩子校验失败&quot;)
        return attrs


class InfoView(APIView):
    def post(self, request):
        ser = InfoSerializer(data=request.data)
        if ser.is_valid():
            return Response(ser.validated_data)
        else:
            return Response(ser.errors)
</code></pre>
<h4 id="324-model">3.2.4 Model校验</h4>
<pre><code class="language-python">from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import serializers
from rest_framework import exceptions
from api import models
from django.core.validators import RegexValidator


class RoleSerializer(serializers.ModelSerializer):
    more = serializers.CharField(required=True)

    class Meta:
        model = models.Role
        fields = [&quot;title&quot;, &quot;order&quot;, &quot;more&quot;]
        extra_kwargs = {
            &quot;title&quot;: {&quot;validators&quot;: [RegexValidator(r&quot;\d+&quot;, message=&quot;格式错误&quot;)]},
            &quot;order&quot;: {&quot;min_value&quot;: 5},
        }

    def validate_more(self, value):
        return value

    def validate(self, attrs):
        return attrs


class InfoView(APIView):
    def post(self, request):
        ser = RoleSerializer(data=request.data)
        if ser.is_valid():
            return Response(ser.validated_data)
        else:
            return Response(ser.errors)
</code></pre>
<h4 id="325">3.2.5 校验+保存</h4>
<pre><code class="language-python">from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import serializers
from rest_framework import exceptions
from api import models
from django.core.validators import RegexValidator


class RoleSerializer(serializers.ModelSerializer):
    more = serializers.CharField(required=True)

    class Meta:
        model = models.Role
        fields = [&quot;title&quot;, &quot;order&quot;, &quot;more&quot;]
        extra_kwargs = {
            &quot;title&quot;: {&quot;validators&quot;: [RegexValidator(r&quot;\d+&quot;, message=&quot;格式错误&quot;)]},
            &quot;order&quot;: {&quot;min_value&quot;: 5},
        }

    def validate_more(self, value):
        return value

    def validate(self, attrs):
        return attrs


class InfoView(APIView):
    def post(self, request):
        ser = RoleSerializer(data=request.data)
        if ser.is_valid():
            ser.validated_data.pop(&quot;more&quot;)
            instance = ser.save()  # ser.save(v1=123,v2=234)
            print(instance)
            return Response(ser.validated_data)
        else:
            return Response(ser.errors)
</code></pre>
<h4 id="326-fkm2m">3.2.6 校验+保存+FK+M2M</h4>
<p><img alt="image-20220917204013619" src="../assets/image-20220917204013619.png" /></p>
<p><img alt="image-20220917204030432" src="../assets/image-20220917204030432.png" /></p>
<pre><code class="language-python">from django.db import models


class Role(models.Model):
    title = models.CharField(verbose_name=&quot;标题&quot;, max_length=32)
    order = models.IntegerField(verbose_name=&quot;顺序&quot;)


class Tag(models.Model):
    caption = models.CharField(verbose_name=&quot;名称&quot;, max_length=32)


class UserInfo(models.Model):
    name = models.CharField(verbose_name=&quot;姓名&quot;, max_length=32)
    gender = models.SmallIntegerField(verbose_name=&quot;性别&quot;, choices=((1, &quot;男&quot;), (2, &quot;女&quot;)))
    role = models.ForeignKey(verbose_name=&quot;角色&quot;, to=&quot;Role&quot;, on_delete=models.CASCADE)
    ctime = models.DateTimeField(verbose_name=&quot;创建时间&quot;, auto_now_add=True)

    tags = models.ManyToManyField(verbose_name=&quot;标签&quot;, to=&quot;Tag&quot;)

</code></pre>
<pre><code class="language-python">from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import serializers
from rest_framework import exceptions
from api import models
from django.core.validators import RegexValidator
import datetime


class UserInfoSerializer(serializers.ModelSerializer):
    more = serializers.CharField(required=True)

    class Meta:
        model = models.UserInfo
        fields = [&quot;name&quot;, &quot;gender&quot;, &quot;role&quot;, &quot;tags&quot;, &quot;more&quot;]
        extra_kwargs = {
            &quot;name&quot;: {&quot;validators&quot;: [RegexValidator(r&quot;n-\d+&quot;, message=&quot;格式错误&quot;)]},
        }

    def validate_more(self, value):
        return value

    def validate(self, attrs):
        return attrs


class InfoView(APIView):
    def post(self, request):
        ser = UserInfoSerializer(data=request.data)
        if ser.is_valid():
            ser.validated_data.pop(&quot;more&quot;)
            instance = ser.save(ctime=datetime.datetime.now())
            print(instance)
            # return Response(ser.validated_data)
            return Response(&quot;成功&quot;)
        else:
            return Response(ser.errors)
</code></pre>
<h4 id="327-create">3.2.7 钩子create</h4>
<p>当执行save时，内部会调用 create 或 update方法，如果想要自定义保存规则，也可以在此处进行处理。</p>
<p><img alt="image-20220918083811336" src="../assets/image-20220918083811336.png" /></p>
<h3 id="33">3.3 校验+序列化</h3>
<p>如果一个请求，即需要做 <strong>请求校验</strong> 又需要做 <strong>序列化</strong> ，怎么搞呢？例如：新增数据。</p>
<ul>
<li>字段，可以通过read_only 、write_only、required 来设定</li>
<li>is_valid校验</li>
<li>data调用序列化</li>
</ul>
<h4 id="331">3.3.1 二合一</h4>
<p><img alt="image-20210823210822789" src="../assets/image-20210823210822789.png" /></p>
<p><img alt="image-20210823211016050" src="../assets/image-20210823211016050.png" /></p>
<p><img alt="image-20210823211041662" src="../assets/image-20210823211041662.png" /></p>
<pre><code class="language-python"># models.py

from django.db import models


class Role(models.Model):
    &quot;&quot;&quot; 角色表 &quot;&quot;&quot;
    title = models.CharField(verbose_name=&quot;名称&quot;, max_length=32)


class Department(models.Model):
    &quot;&quot;&quot; 部门表 &quot;&quot;&quot;
    title = models.CharField(verbose_name=&quot;名称&quot;, max_length=32)


class UserInfo(models.Model):
    &quot;&quot;&quot; 用户表 &quot;&quot;&quot;
    level_choices = ((1, &quot;普通会员&quot;), (2, &quot;VIP&quot;), (3, &quot;SVIP&quot;),)
    level = models.IntegerField(verbose_name=&quot;级别&quot;, choices=level_choices, default=1)

    username = models.CharField(verbose_name=&quot;用户名&quot;, max_length=32)
    password = models.CharField(verbose_name=&quot;密码&quot;, max_length=64)
    age = models.IntegerField(verbose_name=&quot;年龄&quot;, default=0)
    email = models.CharField(verbose_name=&quot;邮箱&quot;, max_length=64, null=True, blank=True)
    token = models.CharField(verbose_name=&quot;TOKEN&quot;, max_length=64, null=True, blank=True)

    depart = models.ForeignKey(verbose_name=&quot;部门&quot;, to=&quot;Department&quot;, on_delete=models.CASCADE, null=True, blank=True)
    roles = models.ManyToManyField(verbose_name=&quot;角色&quot;, to=&quot;Role&quot;)

</code></pre>
<pre><code class="language-python"># urls.py

from django.urls import path, re_path, include
from app01 import views

urlpatterns = [
    path('api/users/', views.UserView.as_view()),
]

</code></pre>
<pre><code class="language-python"># views.py

from django.core.validators import EmailValidator
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import serializers

from app01 import models


class DepartModelSerializer(serializers.ModelSerializer):
    class Meta:
        model = models.Department
        fields = ['id', &quot;title&quot;]
        extra_kwargs 
            &quot;id&quot;: {&quot;read_only&quot;: False},  # 数据验证
            &quot;title&quot;: {&quot;read_only&quot;: True}  # 序列化
        }


class RoleModelSerializer(serializers.ModelSerializer):
    class Meta:
        model = models.Role
        fields = ['id', &quot;title&quot;]
        extra_kwargs = {
            &quot;id&quot;: {&quot;read_only&quot;: False},  # 数据验证
            &quot;title&quot;: {&quot;read_only&quot;: True}  # 序列化
        }


class UserModelSerializer(serializers.ModelSerializer):
    level_text = serializers.CharField(source=&quot;get_level_display&quot;, read_only=True)

    # Serializer嵌套，不是read_only，一定要自定义create和update，自定义新增和更新的逻辑。
    depart = DepartModelSerializer(many=False)
    roles = RoleModelSerializer(many=True)

    extra = serializers.SerializerMethodField(read_only=True)
    email2 = serializers.EmailField(write_only=True)

    # 数据校验：username、email、email2、部门、角色信息
    class Meta:
        model = models.UserInfo
        fields = [
            &quot;username&quot;, &quot;age&quot;, &quot;email&quot;, &quot;level_text&quot;, &quot;depart&quot;, &quot;roles&quot;, &quot;extra&quot;, &quot;email2&quot;
        ]
        extra_kwargs = {
            &quot;age&quot;: {&quot;read_only&quot;: True},
            &quot;email&quot;: {&quot;validators&quot;: [EmailValidator, ]},
        }

    def get_extra(self, obj):
        return 666

    def validate_username(self, value):
        return value

    # 新增加数据时
    def create(self, validated_data):
        &quot;&quot;&quot; 如果有嵌套的Serializer，在进行数据校验时，只有两种选择：
              1. 将嵌套的序列化设置成 read_only
              2. 自定义create和update方法，自定义新建和更新的逻辑
            注意：用户端提交数据的格式。
        &quot;&quot;&quot;
        depart_id = validated_data.pop('depart')['id']

        role_id_list = [ele['id'] for ele in validated_data.pop('roles')]

        # 新增用户表
        validated_data['depart_id'] = depart_id
        user_object = models.UserInfo.objects.create(**validated_data)

        # 在用户表和角色表的关联表中添加对应关系
        user_object.roles.add(*role_id_list)

        return user_object


class UserView(APIView):
    &quot;&quot;&quot; 用户管理 &quot;&quot;&quot;

    def get(self, request):
        &quot;&quot;&quot; 添加用户 &quot;&quot;&quot;
        queryset = models.UserInfo.objects.all()
        ser = UserModelSerializer(instance=queryset, many=True)
        return Response({&quot;code&quot;: 0, 'data': ser.data})

    def post(self, request):
        &quot;&quot;&quot; 添加用户 &quot;&quot;&quot;
        ser = UserModelSerializer(data=request.data)
        if not ser.is_valid():
            return Response({'code': 1006, 'data': ser.errors})

        ser.validated_data.pop('email2')

        instance = ser.save(age=18, password=&quot;123&quot;, depart_id=1)

        # 新增之后的一个对象（内部调用UserModelSerializer进行序列化）
        print(instance)
        # ser = UserModelSerializer(instance=instance, many=False)
        # ser.data

        return Response({'code': 0, 'data': ser.data})

</code></pre>
<h4 id="332">3.3.2 独立分开</h4>
<p>在执行不同功能时，分别使用不同的序列化器来进行处理业务。</p>
<ul>
<li>GET请求，返回数据（序列化A）</li>
<li>POST请求，提交数据（序列化A） + 返回数据（序列化B）。</li>
</ul>
<p><strong>底层源码实现：</strong></p>
<p>序列化的底层源码实现有别于上述其他的组件，序列化器相关类的定义和执行都是在视图中被调用的，所以源码的分析过程可以分为：定义类、序列化、数据校验。</p>
<p>源码1：序列化过程</p>
<p><img alt="image-20210823235237512" src="../assets/image-20210823235237512.png" /></p>
<p><img alt="image-20210823235752483" src="../assets/image-20210823235752483.png" /></p>
<p>源码2：数据校验过程</p>
<p><img alt="image-20210824001814091" src="../assets/image-20210824001814091.png" /></p>
<p><img alt="image-20210824001844381" src="../assets/image-20210824001844381.png" /></p>
<h2 id="4">4.分页</h2>
<p>在查看数据列表的API中，如果 数据量 比较大，肯定不能把所有的数据都展示给用户，而需要通过分页展示。</p>
<p>在drf中为我们提供了一些分页先关类：</p>
<pre><code>BasePagination，分页基类
PageNumberPagination(BasePagination)    支持 /accounts/?page=4&amp;page_size=100 格式的分页
LimitOffsetPagination(BasePagination)   支持 ?offset=100&amp;limit=10 格式的分页
CursorPagination(BasePagination)        支持 上一下 &amp; 下一页 格式的分页（不常用）
</code></pre>
<h3 id="41-pagenumberpagination">4.1 PageNumberPagination</h3>
<p><img alt="image-20210826165642846" src="../assets/image-20210826165642846.png" /></p>
<p><img alt="image-20210826165918075" src="../assets/image-20210826165918075.png" /></p>
<h3 id="42-limitoffsetpagination">4.2 LimitOffsetPagination</h3>
<p><img alt="image-20210826170617347" src="../assets/image-20210826170617347.png" /></p>
<h2 id="5_1">5.初识视图</h2>
<p>APIView`是drf中 “顶层” 的视图类，在他的内部主要实现drf基础的组件的使用，例如：版本、认证、权限、限流等。</p>
<pre><code class="language-python"># urls.py

from django.urls import path, re_path, include
from app01 import views

urlpatterns = [
    path('api/users/', views.UserView.as_view()),
    path('api/users/&lt;int:pk&gt;/', views.UserDetailView.as_view()),
    # 其他分页、筛选等条件，都是要放在 ?page=1&amp;size=9来 传参。
]
</code></pre>
<pre><code class="language-python"># views.py

from rest_framework.views import APIView
from rest_framework.response import Response

class UserView(APIView):

    # 认证、权限、限流等

    def get(self, request):
        # 业务逻辑：查看列表
        return Response({&quot;code&quot;: 0, 'data': &quot;...&quot;})

    def post(self, request):
        # 业务逻辑：新建
        return Response({'code': 0, 'data': &quot;...&quot;})

class UserDetailView(APIView):

    # 认证、权限、限流等

    def get(self, request,pk):
        # 业务逻辑：查看某个数据的详细
        return Response({&quot;code&quot;: 0, 'data': &quot;...&quot;})

    def put(self, request,pk):
        # 业务逻辑：全部修改
        return Response({'code': 0, 'data': &quot;...&quot;})

    def patch(self, request,pk):
        # 业务逻辑：局部修改
        return Response({'code': 0, 'data': &quot;...&quot;})

    def delete(self, request,pk):
        # 业务逻辑：删除
        return Response({'code': 0, 'data': &quot;...&quot;})
</code></pre>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.8fd75fb4.min.js"></script>
      
    
  </body>
</html>